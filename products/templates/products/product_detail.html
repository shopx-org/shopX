{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block CSS-JS %}
    <script id="variant-matrix" type="application/json">
    {{ variant_matrix_json|default:'{}'|safe }}
  </script>
    <script id="price-chart-data" type="application/json">
    {{ price_chart_json|default:'{}'|safe }}
  </script>

    <script src="{% static 'products/js/chart.umd.min.js' %}" defer></script>

    {% if product_jsonld %}
        <script type="application/ld+json">{{ product_jsonld|safe }}</script>
    {% endif %}

    <script src="{% static 'products/js/product.js' %}" defer></script>
{% endblock %}

{% block content %}
    {% static 'images/products/single/1.jpg' as FALLBACK_IMG %}
    {% static 'images/products/single/1-small.jpg' as FALLBACK_THUMB %}

    <main class="main tlp-product">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="breadcrumb-nav border-0 mb-0">
            <div class="container d-flex align-items-center">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'home:home' %}">خانه</a></li>
                    {% if breadcrumbs %}
                        {% for bc in breadcrumbs %}
                            <li class="breadcrumb-item"><a href="{{ bc.url }}">{{ bc.name }}</a></li>
                        {% endfor %}
                    {% elif product.category %}
                        <li class="breadcrumb-item"><a
                                href="{{ product.category.get_absolute_url }}">{{ product.category.name }}</a></li>
                    {% endif %}
                    <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
                </ol>
            </div>
        </nav>

        <div class="page-content">
            <div class="container">
                <section class="tlp-hero ui-compact" dir="rtl">
                    <div class="row g-3 align-items-start">

                        <!-- کارت راست: گالری + اطلاعات محصول -->
                        <div class="col-xl-9 col-lg-8 order-lg-2">
                            <div class="card-like wm-main">
                                <div class="row g-3">

                                    <!-- گالری: ستون راست -->
                                    <div class="col-lg-6 order-lg-2">
                                        <section class="tlp-gallery gallery-rtl-right" aria-label="گالری محصول"
                                                 dir="rtl">
                                            <!-- استیج -->
                                            <div class="stage card-like">
                                                <img id="tlp-main"
                                                     src="{{ gallery_images.0.url|default:FALLBACK_IMG }}"
                                                     alt="{{ gallery_images.0.alt|default:product.name }}"
                                                     loading="eager" decoding="async">
                                            </div>

                                            <!-- ردیف تامب‌ها -->
                                            <div class="thumbs" role="list">
                                                {% if gallery_images %}
                                                    {% for img in gallery_images %}
                                                        <button class="thumb{% if img.is_primary or forloop.first %} is-active{% endif %}"
                                                                type="button" role="listitem"
                                                                aria-pressed="{% if img.is_primary or forloop.first %}true{% else %}false{% endif %}"
                                                                title="{{ product.name }} - {{ forloop.counter }}"
                                                                data-full="{{ img.url }}">
                                                            <img src="{{ img.url }}"
                                                                 alt="{{ img.alt|default:product.name }}"
                                                                 loading="lazy" decoding="async">
                                                        </button>
                                                    {% endfor %}
                                                {% else %}
                                                    <button class="thumb is-active" type="button" role="listitem"
                                                            aria-pressed="true" title="{{ product.name }}"
                                                            data-full="{{ FALLBACK_IMG }}">
                                                        <img src="{{ FALLBACK_THUMB }}" alt="{{ product.name }}"
                                                             loading="lazy" decoding="async">
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </section>
                                    </div>

                                    <!-- اطلاعات/رنگ/سایز/...: ستون چپ -->
                                    <div class="col-lg-6 order-lg-1">
                                        <div class="product-details">

                                            <!-- عنوان -->
                                            <h1 class="product-title">{{ product.name }}</h1>

                                            <!-- امتیاز (در صورت نیاز بعداً داینامیک می‌شود) -->
                                            <div class="ratings-container mt-2">
                                                <div class="ratings">
                                                    <div class="ratings-val" style="width: 80%;"></div>
                                                </div>
                                                <a class="ratings-text" href="#comments"
                                                   id="review-link">( {{ product.review_count|default:0 }} نظر )</a>
                                            </div>

                                            <!-- توضیح کوتاه/متا/بخشی از شرح -->
                                            <div class="product-content">
                                                {% if product.short_description %}
                                                    <p>{{ product.short_description }}</p>
                                                {% elif product.meta_description %}
                                                    <p>{{ product.meta_description }}</p>
                                                {% else %}
                                                    <p>{{ product.description|default_if_none:""|truncatechars:220 }}</p>
                                                {% endif %}
                                            </div>

                                            <!-- رنگ‌ها (سواچ) -->
                                            <div class="details-filter-row details-row-size">
                                                <label>رنگ : </label>
                                                <div class="product-nav product-nav-dots" id="color-swatches">
                                                    {% if colors %}
                                                        {% for c in colors %}
                                                            <a href="javascript:;"
                                                               class="{% if forloop.first %}active{% endif %}"
                                                               data-color-id="{{ c.id }}"
                                                               style="background: {{ c.hex_code }};">
                                                                <span class="sr-only">{{ c.name }}</span>
                                                            </a>
                                                        {% endfor %}
                                                    {% else %}
                                                        <span class="text-muted">بدون تنوع رنگ</span>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <!-- سایز (فعلاً ثابت/نمونه؛ بعداً با واریانت‌ها همسان می‌شود) -->
                                            <div class="details-filter-row details-row-size">
                                                <label for="size">سایز : </label>
                                                <div class="select-custom">
                                                    <select name="size" id="size" class="form-control">
                                                        <option value="#" selected>سایز را انتخاب کنید</option>
                                                        <option value="S">کوچک (Small)</option>
                                                        <option value="M">متوسط (Medium)</option>
                                                        <option value="L">بزرگ (Large)</option>
                                                        <option value="XL">خیلی بزرگ (XL)</option>
                                                    </select>
                                                </div>
                                                <a href="#" class="size-guide"><i class="icon-th-list"></i>راهنمای
                                                    اندازه</a>
                                            </div>

                                            <!-- CTAهای ثانویه -->
                                            <div class="product-details-action">
                                                <div class="details-action-wrapper">
                                                    <a href="#" class="btn-product btn-wishlist"
                                                       title="لیست علاقه‌مندی"><span>افزودن به لیست علاقه‌مندی</span></a>
                                                    <a href="#" class="btn-product btn-compare" title="مقایسه"><span>افزودن به لیست مقایسه</span></a>
                                                </div>
                                            </div>

                                            <!-- دسته‌بندی و شبکه‌های اجتماعی -->
                                            <div class="product-details-footer">
                                                <div class="product-cat text-center">
                                                    <span>دسته‌بندی : </span>
                                                    {% if product.category %}
                                                        <a href="{{ product.category.get_absolute_url }}">{{ product.category.name }}</a>
                                                    {% else %}
                                                        <span class="text-muted">نامشخص</span>
                                                    {% endif %}
                                                </div>

                                                <div class="social-icons social-icons-sm">
                                                    <span class="social-label">اشتراک گذاری : </span>
                                                    <a href="#" class="social-icon" title="فیسبوک" target="_blank"><i
                                                            class="icon-facebook-f"></i></a>
                                                    <a href="#" class="social-icon" title="توییتر" target="_blank"><i
                                                            class="icon-twitter"></i></a>
                                                    <a href="#" class="social-icon" title="اینستاگرام"
                                                       target="_blank"><i class="icon-instagram"></i></a>
                                                    <a href="#" class="social-icon" title="پینترست" target="_blank"><i
                                                            class="icon-pinterest"></i></a>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <!-- کارت چپ: خرید/قیمت/ارسال -->
                        <aside class="col-xl-3 col-lg-4 order-lg-1">
                            <div class="dk-buybox card-like sticky-col">

                                <!-- عملکرد -->
                                <div class="dk-seller">
                                    <a href="#" class="lnk">عملکرد این محصول</a>
                                    <span class="badge dk-badge-ok">عملکرد خوب</span>
                                </div>

                                <!-- قیمت -->
                                <div class="dk-price">
                                    <div class="num">
                                        <span id="price-num">{{ product.price|floatformat:0|intcomma }}</span>
                                        <small>تومان</small>
                                    </div>

                                    {% if product.compare_at_price %}
                                        <div class="save">
                                            <del id="compare-num">{{ product.compare_at_price|floatformat:0|intcomma }}</del>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- گزینه‌ها -->
                                <div class="dk-rows">
                                    <div class="dk-row">
                                        <label>گارانتی</label>
                                        <div class="v">{{ product.warranty_text|default:"—" }}</div>
                                    </div>
                                    <div class="details-filter-row details-row-size">
                                        <label for="qty">تعداد : </label>
                                        <div class="product-details-quantity">
                                            <input type="number" id="qty" class="form-control" value="1" min="1"
                                                   max="10" step="1" data-decimals="0" required>
                                        </div>
                                    </div>
                                </div>

                                <!-- CTA -->
                                <div class="dk-cta">
                                    <button class="btn dk-add">
                                        <i class="icon-shopping-cart"></i>
                                        <span>افزودن به سبد خرید</span>
                                    </button>
                                </div>

                                {% if stock_info and stock_info.is_low %}
                                    <p class="mt-2 low-stock" style="font-weight:700;color:red;">
                                        تنها {{ stock_info.min_stock|default:stock_info.total_stock }} عدد در انبار باقی
                                        مانده
                                    </p>
                                {% endif %}

                            </div>

                            <!-- اطلاعات ارسال و ضمانت -->
                            <div class="dk-info card-like sticky-gap mb-2">
                                <div class="dk-row"><label><i class="icon-truck"></i> روش و هزینه ارسال</label>
                                    <div class="v">{{ product.shipping_text|default:"ارسال سریع • تامین از ۱ روز کاری دیگر" }}</div>
                                </div>
                                <div class="dk-row"><label><i class="icon-check"></i> اصالت و سلامت کالا</label>
                                    <div class="v">ضمانت اصالت و سلامت فیزیکی</div>
                                </div>
                                <div class="dk-row"><label><i class="icon-rotate-left"></i> بازگشت</label>
                                    <div class="v">۷ روز مهلت بازگشت</div>
                                </div>
                            </div>
                        </aside>

                    </div>
                </section>

                <!-- نمودار قیمت (فقط مارکاپ؛ بدون JS) -->
                <section class="tlp-hero ui-compact mt-0" dir="rtl">
                    <div class="row g-3 align-items-start">
                        <div class="col-xl-9 col-lg-8 order-lg-2">
                            <div class="card-like wm-main">
                                <div class="row g-3">
                                    <div class="col-lg-12 order-lg-2">
                                        <div class="card custom-card">
                                            <div class="card-header">
                                                <div class="card-title">نمودار تغییرات قیمت این محصول</div>
                                            </div>
                                            <div id="line-chart">
                                                <canvas id="priceLineChart" aria-label="نمودار روند قیمت"
                                                        role="img"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- اکاردئون خدمات جانبی -->
                        <aside class="col-xl-3 col-lg-4 order-lg-1 mt-2">
                            <details class="dk-acc card-like">
                                <summary>
                                    <span class="">خدمات نصب و راه‌اندازی</span>
                                    <label class="switch"><input type="checkbox" id="svc-toggle"><span
                                            class="slider"></span></label>
                                </summary>
                                <div class="dk-acc-body">
                                    <label class="opt">
                                        <input type="checkbox" id="install-chk">
                                        <span class="ttl">نصب در محل</span>
                                        <span class="price muted">هزینه پس از خرید مشخص می‌شود</span>
                                    </label>
                                    <div class="dk-acc-foot"><a href="#" class="lnk">جزئیات</a></div>
                                </div>
                            </details>

                            <details class="dk-acc card-like" open>
                                <summary>
                                    <span class="t">بیمه</span>
                                    <label class="switch"><input type="checkbox" id="ins-toggle" checked><span
                                            class="slider"></span></label>
                                </summary>
                                <div class="dk-acc-body">
                                    <label class="opt">
                                        <input type="radio" name="ins" checked>
                                        <span class="ttl">بیمه تجهیزات دیجیتال سامان</span>
                                        <span class="off">٪۵</span>
                                        <span class="price">۱,۰۲۳,۰۰۰ <small>تومان</small></span>
                                    </label>
                                    <div class="dk-acc-foot"><a href="#" class="lnک">جزئیات</a></div>
                                </div>
                            </details>
                        </aside>
                    </div>
                </section>

                <!-- بنر ویژگی‌ها -->
                <div class="container px-0 mt-2">
                    <div class="justify-content-between align-items-center w-100 px-3 pt-3 pb-4 d-flex my-3 product-feature-all">
                        <div class="features-banner w-100 d-flex mx-auto gap-y-2 justify-content-between">
                            <a href="#">
                                <div class="feature-box d-flex flex-row justify-content-center align-items-center px-1">
                                    <div class="d-inline-block-lg ml-2 feature-img">
                                        <img src="{% static 'images/products/features/express-delivery.svg' %}" alt="">
                                    </div>
                                    <p class="feature-text">امکان تحویل اکسپرس</p></div>
                            </a>
                            <a href="#">
                                <div class="feature-box d-flex flex-row justify-content-center align-items-center px-1">
                                    <div class="d-inline-block-lg ml-2 feature-img">
                                        <img src="{% static 'images/products/features/support.svg' %}" alt="">
                                    </div>
                                    <p class="feature-text">24 ساعته، 7 روز هفته</p></div>
                            </a>
                            <a href="#">
                                <div class="feature-box d-flex flex-row justify-content-center align-items-center px-1">
                                    <div class="d-inline-block-lg ml-2 feature-img">
                                        <img src="{% static 'images/products/features/cash-on-delivery.svg' %}" alt="">
                                    </div>
                                    <p class="feature-text">امکان پرداخت در محل</p></div>
                            </a>
                            <a href="#">
                                <div class="feature-box d-flex flex-row justify-content-center align-items-center px-1">
                                    <div class="d-inline-block-lg ml-2 feature-img">
                                        <img src="{% static 'images/products/features/days-return.svg' %}" alt="">
                                    </div>
                                    <p class="feature-text">هفت روز ضمانت بازگشت کالا</p></div>
                            </a>
                            <a href="#">
                                <div class="feature-box d-flex flex-row justify-content-center align-items-center px-1">
                                    <div class="d-inline-block-lg ml-2 feature-img">
                                        <img src="{% static 'images/products/features/original-products.svg' %}" alt="">
                                    </div>
                                    <p class="feature-text">ضمانت اصل بودن کالا</p></div>
                            </a>
                        </div>
                    </div>

                    <!-- محصولات مرتبط -->
                    <div class="container">
                        <h2 class="title text-center mb-4">محصولاتی که شاید بپسندید</h2>
                        <div class="owl-carousel owl-simple carousel-equal-height carousel-with-shadow"
                             data-toggle="owl"
                             data-owl-options='{"nav":false,"dots":true,"margin":20,"loop":false,"rtl":true,
               "responsive":{"0":{"items":1},"480":{"items":2},"768":{"items":3},"992":{"items":4},"1200":{"items":4,"nav":true,"dots":false}}}'>
                            {% for r in related_products %}
                                <div class="product product-7 text-center">
                                    <figure class="product-media">
                                        <a href="{{ r.get_absolute_url }}">
                                            {% with img=r.images.all|first %}
                                                {% if img %}
                                                    <img src="{{ img.image.url }}" alt="{{ img.alt|default:r.name }}"
                                                         class="product-image">
                                                {% else %}
                                                    <img src="{% static 'images/products/product-4.jpg' %}"
                                                         alt="{{ r.name }}" class="product-image">
                                                {% endif %}
                                            {% endwith %}
                                        </a>
                                    </figure>
                                    <div class="product-body">
                                        <div class="product-cat text-center">
                                            {% if r.category %}
                                                <a href="{{ r.category.get_absolute_url }}">{{ r.category.name }}</a>{% else %}
                                                <span class="text-muted">—</span>{% endif %}
                                        </div>
                                        <h3 class="product-title text-center"><a
                                                href="{{ r.get_absolute_url }}">{{ r.name }}</a></h3>
                                        <div class="product-price">{{ r.price|floatformat:0|intcomma }} تومان</div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="text-center text-muted p-3">محصول مرتبطی پیدا نشد.</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- تب‌ها: مشخصات / فنی / نظرات -->
                <div class="product-details-tab product-details-extended mt-5">
                    <div class="product-tab-new">
                        <div class="page-content">
                            <div class="container">

                                <div class="row">
                                    <div class="col-md-11">
                                        <div class="accordion" id="accordion-1">

                                            <!-- مشخصات (خلاصه) -->
                                            <div class="card">
                                                <div class="card-header" id="heading-1">
                                                    <h2 class="card-title">
                                                        <a role="button" data-toggle="collapse" href="#collapse-1"
                                                           aria-expanded="true" aria-controls="collapse-1">مشخصات</a>
                                                    </h2>
                                                </div>
                                                <div id="collapse-1" class="collapse show" aria-labelledby="heading-1"
                                                     data-parent="#accordion-1">
                                                    <div class="card-body">
                                                        {% if product.description %}
                                                            {{ product.description|linebreaks }}
                                                        {% else %}
                                                            <span class="text-muted">توضیحی ثبت نشده است.</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- مشخصات فنی (ویژگی‌ها) -->
                                            <div class="card">
                                                <div class="card-header" id="heading-2">
                                                    <h2 class="card-title">
                                                        <a class="collapsed" role="button" data-toggle="collapse"
                                                           href="#collapse-2" aria-expanded="false"
                                                           aria-controls="collapse-2">
                                                            مشخصات فنی
                                                        </a>
                                                    </h2>
                                                </div>
                                                <div id="collapse-2" class="collapse" aria-labelledby="heading-2"
                                                     data-parent="#accordion-1">
                                                    <div class="card-body">
                                                        {% if product.attr_values.all %}
                                                            <div class="table-responsive">
                                                                <table class="table table-striped" dir="rtl">
                                                                    <tbody>
                                                                    {% for av in product.attr_values.all %}
                                                                        <tr>
                                                                            <th style="width:35%">{{ av.attribute.name }}</th>
                                                                            <td>
                                                                                {% if av.value_text %}
                                                                                    {{ av.value_text }}
                                                                                    {% elif av.value_choice %}{{ av.value_choice.name }}
                                                                                {% else %}
                                                                                    <span class="text-muted">—</span>{% endif %}
                                                                            </td>
                                                                        </tr>
                                                                    {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        {% else %}
                                                            <span class="text-muted">ویژگی‌ای ثبت نشده است.</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- نظرات (فعلاً مارکاپ نمونه) -->
                                            <div class="card">
                                                <div class="card-header" id="heading-3">
                                                    <h2 class="card-title">
                                                        <a class="collapsed" role="button" data-toggle="collapse"
                                                           href="#collapse-3" aria-expanded="false"
                                                           aria-controls="collapse-3">
                                                            نظرات
                                                        </a>
                                                    </h2>
                                                </div>
                                                <div id="collapse-3" class="collapse" aria-labelledby="heading-3"
                                                     data-parent="#accordion-1">
                                                    <div class="text-right mt-4 border-t" id="comments">
                                                        <div class="reviews">
                                                            <div class="container mt-3">
                                                                <span class="text-muted">سیستم نظرات به‌زودی متصل می‌شود.</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div> <!-- /accordion -->
                                    </div>
                                </div> <!-- /row -->

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sticky Bar شبیه تکنولایف -->
                <div class="tlp-sticky">
                    <div class="container d-flex align-items-center justify-content-between">
                        <div class="sum">
                            {% with img=gallery_images.0 %}
                                {% if img %}
                                    <img src="{{ img.url }}" alt="{{ img.alt|default:product.name }}">
                                {% else %}
                                    <img src="{{ FALLBACK_THUMB }}" alt="{{ product.name }}">
                                {% endif %}
                            {% endwith %}
                            <div class="txt">
                                <div class="t1">{{ product.name }}</div>
                                <div class="t2">{{ product.price|floatformat:0|intcomma }} تومان</div>
                            </div>
                        </div>
                        <button class="btn bb-add"><i class="icon-shopping-cart"></i><span>افزودن به سبد</span></button>
                    </div>
                </div>

            </div>
        </div>
    </main>

{% endblock %}

